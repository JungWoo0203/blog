# Next.js Link로 바꿨더니 CSS가 망가졌다: CSR vs SSR 스타일 로딩의 함정

이 블로그의 첫 개발 관련 글이다. 첫 글이니만큼 잘쓰고 싶은 마음이 큰 한편 잘 작성할 수 있을지 걱정이 많다.
최선을 다해 쓸테지만 많은 개선점들이 있을테니 언제든 피드백 바란다.

해당 내용은 실무를 할 때 실제로 겪었던 문제이고, 처음에는 원인 파악이 안되어 4시간정도 삽질했던 일이 있었다.
그리고 이 문제는 개발하다보면 종종 발생하는 문제일 것 같아 작성하게 되었다.

이제부터 내가 마주했던 문제과 어떤 사고로 이 문제를 해결하려고 했는지에 대해 써내려갈 생각이다.

## 줄거리

### 건드린게 없는데 CSS가 망가진다?

나는 평화롭게 게시판 글로 이동하는 코드를 작성하고 테스트를 하고 있었다.
테스트를 하던 그때 갑자기 이동한 게시판 글에서 보여지는 이미지들의 크기가 원본 사이즈로 보여지기 시작했다.
여기서 문제는 나는 게시판 글로 이동하는 코드만 작성했을 뿐, 게시판에 대한 로직을 건든 적이 없다.

처음 든 생각은 글로 이동하는 과정에서 css가 누락이 되었나? 라는 생각이였다.
하지만 문제는 이미지들만 있을뿐, 나머지 css들은 모두 정상적으로 들어가는 것이 문제였다.
그리고 게시판 글에서 새로고침 후에는 뒤로 돌아가기를 누르고 다시 게시판 글로 이동할 때 이미지가 정상적으로 보여졌다.

### 넌 어케했는데?

대체 왜 이미지가 이상해질까 고민을 하던 중 게시판에서는 게시판 글에 진입 시에는 문제가 없다는 사실을 발견하였고,
게시판에서 게시판 글에 진입하는 로직을 확인했다.
그때 게시판에서 게시판 글로 진입할 때에는 `window.location.href`으로 이동한다는 사실을 발견하였다.

나는 게시판 글을 이동하는 코드를 Next.js의 Link로 구현했기 때문에 이게 원인이구나 생각이 들어 Link로 구현했던 것을 window.open으로 변경하여 실행해보았더니 귀신같이 정상적으로 이미지가 보여졌다.

그렇다면 왜? Link와 window.open/window.location.href가 어떤 차이가 있길래 이런 문제가 발생하는 걸까?

## Link와 window.open의 차이

우선 Link와 window.open의 명확한 차이는 Link는 CSR으로 렌더링이 되고, window.open은 창을 새롭게 여는 것이기 때문에 SSR로 렌더링 된다고 볼 수 있다.

여기서 우리가 주목해야할 점은 SSR은 모든 CSS가 올바른 순서대로 새로 로드되는 반면, CSR은 기존 CSSOM에 인라인 스타일만 추가된다.

조금 더 깊게 보면

window.open 사용 시

1. 새 탭/창이 열리고,
2. 서버에서 완전한 HTML이 생성 되고 (SSR)
3. CSS 파일들이 올바른 순서로 로드된다.
4. 그렇기 때문에 의도된 스타일링이 구현될 수 있다.

Link 사용시

1. 기존 탭에서 JavaScript 라우팅이 이루어지고 (CSR)
2. 기존 CSSOM은 유지가 된다.
3. 그렇기에 추가된 style은 기존 CSS 뒤에 추가가 되고,
4. 브라우저는 마지막 스타일을 더 높은 우선순위로 처리하기 때문에 (CSS Cascade)
5. 의도한 대로 CSS가 적용되지 않고 가장 처음에 적용되는 바람에 문제가 발생한다.

즉, 두개의 라우팅 방식의 차이로 인해 CSS 적용 순서의 차이가 생겨 발생한 문제라는 것이다.

## CSS Cascade요? 그게 뭐에요?

CSS Cascade는 여러 CSS 규칙이 같은 요소에 적용될 때 어떤 규칙이 최종적으로 적용될지 결정하는 메커니즘이다.
우선순위 결정 요소는 아래의 순서와 같다.

1. 중요도
2. 명시도
3. 소스 순서

## 마무리

생각지도 못한 문제로 삽질을 하긴 했지만 삽질은 개발자의 숙명 아니던가, 오히려 급할 때 생긴 문제가 아니여서 오히려 좋다는 생각이다.

이 문제를 겪었기 때문에 렌더링 관련해서 문제가 생겼을 때 삽질을 덜 할 수 있을 거다.

아직 모르는 것이 많기에 더 정진해야겠다.
